<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="css/bootstrap.css" rel="stylesheet">

    <title>Document</title>
</head>

<body>
    <div class="container">
        <div class="row">
            <div class="col-xs-6 col-lg-6">
                <div class="form-group">
                    <label for="InputFileButton">Browse</label>
                    <input class="btn btn-primary" type="file" id="InputFileButton" onchange="LoadTextFile()">
                </div>
                <textarea id="textarea1" class="form-control" rows="38" columns="20"></textarea>
            </div>
            <div class="col-xs-6 col-lg-6">
                <form class="form-inline">

                    <!-- <div class="checkbox">
                        <label>
                            <input type="checkbox" id="checkbox1"> Show Only :
                        </label>
                    </div> -->

                    <select id="select1" class="form-control" onchange="PopulateSelects('select1')">

                    </select>

                    <select id="select2" class="form-control" onchange="PopulateSelects('select2')">

                    </select>

                    <select id="select3" class="form-control" onchange="PopulateSelects('select3')">

                    </select>

                    <select id="select4" class="form-control" onchange="PopulateSelects('select4')">

                    </select>


                    <button type="button" class="btn btn-primary" onclick="ShowResultBasedOnSelectedOptions()">Show</button>

                </form>
                <!-- <br> -->
                <!-- <form class="form-inline">
                    <div class="form-group">
                        <label for="SubConfig">SubConfig must Contain: </label>
                        <input type="text" class="form-control" id="SubConfigInput" placeholder="input text here..."> 
                    </div>
                </form> -->
                <form autocomplete="off">
                    <!-- I remove: action="/action_page.php" -->
                    <div class="autocomplete" style="width:300px;">
                        <!-- <label for="myInput">SubConfig must Contain: </label> -->
                        <input id="myInput" type="text" name="subConfig" placeholder="Sub Config">
                    </div>
                    <!-- <input type="submit"> -->
                </form>

                <br>
                <textarea id="textarea2" class="form-control" rows="28" columns="20"></textarea>
                <!-- <button id="button2" class="btn btn-default" onclick="PopulateFirstSelect(['interface', 'ip', 'controller'])">PopulateSelect1</button>
                <button id="button3" class="btn btn-default" onclick="ResetElement('select1')">ResetElement</button>
                <button id="button4" class="btn btn-default" onclick="ClearOptions('select1')">ClearOptions</button>
                <button id="button5" class="btn btn-default" onclick="ReadTextAreaContent()">ReadTextArea</button>
                <button id="button6" class="btn btn-default" onclick="ShowAsciiCodeOfChars('show ver ')">ShowAsciiCodeOfChars</button> -->

            </div>
        </div>
    </div>



    <script src="/js/jquery-3.3.1.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="/js/bootstrap.js"></script>
    <script>

        var rootConfig = new Node('rootConfig');

        function Node(value) {

            this.value = value;
            this.children = [];
            this.parent = null;

            this.setParentNode = function (node) {
                this.parent = node;
            }

            this.getParentNode = function () {
                return this.parent;
            }

            this.addChild = function (node) {
                node.setParentNode(this);
                this.children[this.children.length] = node;
            }

            this.getChildren = function () {
                return this.children;
            }

            this.removeChildren = function () {
                this.children = [];
            }
        }


        // Load textarea by selected config file from input btn

        function LoadTextFile() {
            var file = document.getElementById('InputFileButton').files[0];
            var reader = new FileReader();
            reader.onload = function (e) {
                var textArea = document.getElementById("textarea1");
                var fileString = e.target.result;
                textArea.value = e.target.result;
                document.getElementById("textarea1").innerHTML = fileString;
                ////////////////////////////////////////////////////////////////////////////////////
                // because it's async, we have to put our logic in this function!

                // reset config tree
                rootConfig.removeChildren();

                var linesOfConfig = document.getElementById("textarea1").value.split("\n");
                CheckEveryLinesOfRawConfig(linesOfConfig);
                var listOfFirstWords = ChildrenValuesInString(rootConfig);
                var preferedItems = ["interface", "ip", "controller", "line", "hostname", "username", "enable", "access-list", "router", "clock", "license", "version"];
                rootConfig = SortNodeChildsBaseOnPreferedItems(rootConfig, preferedItems);

                PopulateThisSelect("select1", rootConfig);
                PopulateSelects("select1");

                /////////////////////////////////////////////////////////////////////////////////////

            };
            reader.readAsText(file);


        }

        function CheckEveryLinesOfRawConfig(linesOfConfig) {
            var firstWordsList = [];
            for (var i = 0; i < linesOfConfig.length; i++) {
                var thisLineOfConfig = linesOfConfig[i];
                if (thisLineOfConfig.length == 0) { continue; }
                if (thisLineOfConfig.charAt(0) === "!" || thisLineOfConfig.charAt(0) === " ") { continue; }

                var wordsInThisLine = thisLineOfConfig.split(" ");
                AddThisLineToConfigTree(wordsInThisLine);
            }
        }

        function ChildrenValuesInString(node) {
            var childsValues = [];
            for (i = 0; i < node.children.length; i++) {
                childsValues.push(node.children[i].value);
            }

            return childsValues;
        }

        function SortNodeChildsBaseOnPreferedItems(node, prefItems) {
            var i = 0;
            var index = 0;
            while (i < prefItems.length) {
                var item = prefItems[i];
                var j = 0;
                while (j < node.children.length) {
                    if (item == node.children[j].value) {
                        var temp = node.children[index];
                        node.children[index] = node.children[j];
                        node.children[j] = temp;
                        index++;
                        break;
                    }
                    j++;
                }
                i++;
            }

            return node;
        }

        // Give string array to a Select to populate its options.
        function PopulateThisSelect(selectId, node) {
            ResetElement(selectId);
            var list = ChildrenValuesInString(node);
            list.push("");
            var firstSelect = document.getElementById(selectId);
            for (var i = 0; i < list.length; i++) {
                var option = document.createElement("OPTION");
                var item = document.createTextNode(list[i]);
                option.appendChild(item);
                option.setAttribute("value", list[i]);
                firstSelect.insertBefore(option, firstSelect.lastChild);
            }
        }

        // function PopulateSelects() {
        //     var selectsOptionList = GetAllSelectedOptions();
        //     for(var i = 0; i < GetAllSelectedOptions.length; i++) {
        //         var thisValue = selectsOptionList[i];
        //         if(thisValue == "") {
        //             for(var j = i+1; j <= 4; j++){
        //                 var selectName = "select" + j;
        //                 ResetElement(selectName);
        //             }
        //         }


        //     }
        //     var selectName = "select" + i;
        //     var 
        // }

        function PopulateSelects(selectId) {
            var thisSelectValue = document.getElementById(selectId).value;
            var list = [];
            switch (selectId) {
                case "select1":
                    ResetElement("select2");
                    ResetElement("select3");
                    ResetElement("select4");
                    if (thisSelectValue == "") {
                        console.log(GetAllSelectedOptions());
                        break;
                    }
                    list.push(thisSelectValue);
                    var findedNode = LocateLastNodeInList(rootConfig, list)
                    if (findedNode.children.length > 0) {
                        PopulateThisSelect("select2", findedNode);
                        PopulateSelects("select2");
                    }
                    else {
                        console.log(GetAllSelectedOptions());
                    }
                    break;

                case "select2":
                    ResetElement("select3");
                    ResetElement("select4");
                    var select1Value = document.getElementById("select1").value;
                    list.push(select1Value);
                    if (thisSelectValue == "") {
                        console.log(GetAllSelectedOptions());
                        break;
                    }
                    else {
                        list.push(thisSelectValue);
                        var findedNode = LocateLastNodeInList(rootConfig, list);
                        if (findedNode.children.length > 0) {
                            PopulateThisSelect("select3", findedNode);
                            PopulateSelects("select3");
                        }
                        else {
                            console.log(GetAllSelectedOptions());
                        }
                    }
                    break;

                case "select3":
                    ResetElement("select4");
                    var select1Value = document.getElementById("select1").value;
                    var select2Value = document.getElementById("select2").value;
                    list.push(select1Value);
                    list.push(select2Value);
                    if (thisSelectValue == "") {
                        console.log(GetAllSelectedOptions());
                        break;
                    }
                    else {
                        list.push(thisSelectValue);
                        var findedNode = LocateLastNodeInList(rootConfig, list);
                        if (findedNode.children.length > 0) {
                            PopulateThisSelect("select4", findedNode);
                        }
                    }
                    console.log(GetAllSelectedOptions());
                    break;
                case "select4":
                    var select1Value = document.getElementById("select1").value;
                    var select2Value = document.getElementById("select2").value;
                    var select3Value = document.getElementById("select3").value;
                    list.push(select1Value);
                    list.push(select2Value);
                    list.push(select3Value);
                    if (thisSelectValue == "") {
                        console.log(GetAllSelectedOptions());
                        break;
                    }
                    else {
                        list.push(thisSelectValue);
                    }
                    console.log(GetAllSelectedOptions());

                    break;

                // default:
                //     break;
            }

        }

        //  Show result base on selected options 
        function GetAllSelectedOptions() {
            var selectOptions = [];
            for (i = 1; i <= 4; i++) {
                var selectName = "select" + i;
                var thisSelect = document.getElementById(selectName);
                if (thisSelect.options.length) {
                    if (thisSelect.value != "") {
                        selectOptions.push(thisSelect.value);
                    }
                }
            }

            return selectOptions;
        }

        function ShowResultBasedOnSelectedOptions() {
            var listOfSelectedOptions = GetAllSelectedOptions();
            var wantedContext = "";
            if (listOfSelectedOptions[0] == "interface") {
                wantedContext = "interface "
                for (var i = 1; i < listOfSelectedOptions.length; i++) {
                    wantedContext += listOfSelectedOptions[i];
                }
            }
            else {
                wantedContext = listOfSelectedOptions.join(" ");
            }
            var linesOfConfig = document.getElementById("textarea1").value.split("\n");
            var searchResult = [];
            var i = 0;
            while (i < linesOfConfig.length) {
                var thisLine = linesOfConfig[i];
                if (thisLine.length == 0) { i++; continue; }
                if (thisLine.charAt(0) === "!" || thisLine.charAt(0) === " ") { i++; continue; }
                if (thisLine.includes(wantedContext)) {
                    searchResult.push(thisLine);
                    i++;
                    var nextline = linesOfConfig[i];
                    while (nextline.charAt(0) == " ") {
                        searchResult.push(nextline);
                        i++;
                        nextline = linesOfConfig[i];
                    }
                    searchResult.push("!");
                    continue;

                }
                i++;
            }
            var resultline = searchResult.join("\n");
            document.getElementById("textarea2").innerHTML = resultline;
            //console.log("Show Btn:" + searchResult);
        }

        function ResetElement(elementId) {
            var element = document.getElementById(elementId);
            element.options.length = 0;
        }

        function ClearOptions(elementId) {
            var element = document.getElementById(elementId);
            while (element.length > 0)
                element.remove(0);
        }

        function ReadTextAreaContent() {
            var linesOfConfig = document.getElementById("textarea1").value.split("\n");
            ShowAsciiCodeOfChars(linesOfConfig[2]);
        }

        function ShowAsciiCodeOfChars(array) {
            var length = array.length;
            var i = 0;
            while (i < length) {
                alert(array[i] + ' : ' + array.charCodeAt(i));
                i++;
            }
        }



        /////////////////////// This function add words in a line of config to rootConfig tree/////////////////////////////

        function AddThisLineToConfigTree(wordsInThisLine) {
            var precededWords = [];
            wordsInThisLine = DivideInterfacesIntoSubString(wordsInThisLine);
            for (var i = 0; i < wordsInThisLine.length; i++) {
                AddNode(precededWords, wordsInThisLine[i])
                precededWords.push(wordsInThisLine[i]);
            }
        }

        function AddNode(precededWords, node) {             // precededParents: words before node in a line of code
            var parent = LocateLastNodeInList(rootConfig, precededWords);
            InsertNodeUnderItsParent(node, parent);
        }

        function LocateLastNodeInList(startNode, precededNodesList) {   // LocateLastNodeInList(startNode, ["service", "timestamp"])
            var lastNode = startNode
            var index = 0;
            while (index < precededNodesList.length) {
                var childs = lastNode.children;
                for (var i = 0; i < childs.length; i++) {
                    if (childs[i].value == precededNodesList[index]) {
                        lastNode = childs[i];
                        index++;
                        break;
                    }
                }
            }

            return lastNode;
        }



        function InsertNodeUnderItsParent(node, parent) {
            var childsOfParent = parent.children;
            var isBetweenChildsAlready = false;
            for (i = 0; i < childsOfParent.length; i++) {
                if (node == parent.children[i].value) {
                    isBetweenChildsAlready = true;
                    break;
                }
            }
            if (isBetweenChildsAlready == false) {
                parent.addChild(new Node(node));
            }

        }

        function DivideInterfacesIntoSubString(wordsInThisLine) {
            var thisLineOfCode = [];
            thisLineOfCode.push(wordsInThisLine[0]);

            for (var i = 1; i < wordsInThisLine.length; i++) {
                var word = wordsInThisLine[i];
                var j = 0;
                var findDigit = false;
                while (j < word.length) {
                    if (word.charCodeAt(j) >= 48 && word.charCodeAt(j) <= 57) {
                        if (word.charCodeAt(j - 1) >= 65 && word.charCodeAt(j - 1) <= 122) {
                            findDigit = true;
                            thisLineOfCode.push(word.substring(0, j));
                            word = word.substring(j, word.length);
                            var indexOfdot = word.indexOf(".");
                            if (indexOfdot == -1) {
                                thisLineOfCode.push(word);
                            }
                            else {
                                thisLineOfCode.push(word.substring(0, indexOfdot));
                                thisLineOfCode.push(word.substring(indexOfdot, word.length));
                            }

                            break;
                        }
                    }
                    j++;

                }

                if (findDigit == false) {
                    thisLineOfCode.push(word);
                }
            }
            return thisLineOfCode
        }
        ///////////////////////////////////// end of functions that add nodes to tree of config ////////////


        //////////////////////////////////////  script for autocomplete text input /////////////////////////
        function autocomplete(inp, arr) {
            /*the autocomplete function takes two arguments,
            the text field element and an array of possible autocompleted values:*/
            var currentFocus;
            /*execute a function when someone writes in the text field:*/
            inp.addEventListener("input", function (e) {
                var a, b, i, val = this.value;
                /*close any already open lists of autocompleted values*/
                closeAllLists();
                if (!val) { return false; }
                currentFocus = -1;
                /*create a DIV element that will contain the items (values):*/
                a = document.createElement("DIV");
                a.setAttribute("id", this.id + "autocomplete-list");
                a.setAttribute("class", "autocomplete-items");
                /*append the DIV element as a child of the autocomplete container:*/
                this.parentNode.appendChild(a);
                /*for each item in the array...*/
                for (i = 0; i < arr.length; i++) {
                    /*check if the item starts with the same letters as the text field value:*/
                    if (arr[i].substr(0, val.length).toUpperCase() == val.toUpperCase()) {
                        /*create a DIV element for each matching element:*/
                        b = document.createElement("DIV");
                        /*make the matching letters bold:*/
                        b.innerHTML = "<strong>" + arr[i].substr(0, val.length) + "</strong>";
                        b.innerHTML += arr[i].substr(val.length);
                        /*insert a input field that will hold the current array item's value:*/
                        b.innerHTML += "<input type='hidden' value='" + arr[i] + "'>";
                        /*execute a function when someone clicks on the item value (DIV element):*/
                        b.addEventListener("click", function (e) {
                            /*insert the value for the autocomplete text field:*/
                            inp.value = this.getElementsByTagName("input")[0].value;
                            /*close the list of autocompleted values,
                            (or any other open lists of autocompleted values:*/
                            closeAllLists();
                        });
                        a.appendChild(b);
                    }
                }
            });
            /*execute a function presses a key on the keyboard:*/
            inp.addEventListener("keydown", function (e) {
                var x = document.getElementById(this.id + "autocomplete-list");
                if (x) x = x.getElementsByTagName("div");
                if (e.keyCode == 40) {
                    /*If the arrow DOWN key is pressed,
                    increase the currentFocus variable:*/
                    currentFocus++;
                    /*and and make the current item more visible:*/
                    addActive(x);
                } else if (e.keyCode == 38) { //up
                    /*If the arrow UP key is pressed,
                    decrease the currentFocus variable:*/
                    currentFocus--;
                    /*and and make the current item more visible:*/
                    addActive(x);
                } else if (e.keyCode == 13) {
                    /*If the ENTER key is pressed, prevent the form from being submitted,*/
                    e.preventDefault();
                    if (currentFocus > -1) {
                        /*and simulate a click on the "active" item:*/
                        if (x) x[currentFocus].click();
                    }
                }
            });
            function addActive(x) {
                /*a function to classify an item as "active":*/
                if (!x) return false;
                /*start by removing the "active" class on all items:*/
                removeActive(x);
                if (currentFocus >= x.length) currentFocus = 0;
                if (currentFocus < 0) currentFocus = (x.length - 1);
                /*add class "autocomplete-active":*/
                x[currentFocus].classList.add("autocomplete-active");
            }
            function removeActive(x) {
                /*a function to remove the "active" class from all autocomplete items:*/
                for (var i = 0; i < x.length; i++) {
                    x[i].classList.remove("autocomplete-active");
                }
            }
            function closeAllLists(elmnt) {
                /*close all autocomplete lists in the document,
                except the one passed as an argument:*/
                var x = document.getElementsByClassName("autocomplete-items");
                for (var i = 0; i < x.length; i++) {
                    if (elmnt != x[i] && elmnt != inp) {
                        x[i].parentNode.removeChild(x[i]);
                    }
                }
            }
            /*execute a function when someone clicks in the document:*/
            document.addEventListener("click", function (e) {
                closeAllLists(e.target);
            });
        }
        
        var subConfigs = ["tunnel source", "tunnel destination", "ip address"];
        autocomplete(document.getElementById("myInput"), subConfigs);

        /////////////////////////////////////// end of script for autocomplete text input //////////////////    



    </script>
</body>

</html>